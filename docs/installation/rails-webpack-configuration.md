# Rails webpack configuration

If you choose to use `kitten` Rails engine, you will have to setup your
application with [React on Rails](https://github.com/shakacode/react_on_rails)
and [webpack](https://webpack.github.io/).

If you are familiar with React on Rails, you can use your own workflow and skip
the following installation. You simply have to:
- add `kitten` sass paths in your SASS path loader;
- add `kitten` javascript modules in your webpack resolving paths.

React on Rails proposes a simple implementation of webpack into the existing
Rails sprockets system:
- Webpack generates javascript and CSS bundles.
- Then, these latters are included in the asset pipeline.

This way, the responsability of fingerprinting (on production environment) is
still delegated to the asset pipeline and does not require a new management of
assets compilation.

## Table of content

- [Files architecture](#files-architecture)
- [Webpack dependencies](#webpack-dependencies)
- Build configuration
- Web-dev server
- React server-side rendering build

## Files architecture

This Rails project structure is not mandatory, but recommended. It is based on the
[structure proposed by React on
Rails](https://github.com/shakacode/react_on_rails/blob/master/docs/additional-reading/recommended-project-structure.md).

```
|_ app
| |_ assets
|   |_ javascripts
|   |_ stylesheets
|   |_ webpack
|
|_ client
| |_ .babelrc
| |
| |_ bin
| | |_ webpack-dev-server.js
| |
| |_ app
| |  |_ javascripts
| |  |_ stylesheets
| |
| |_ config
| |  |_ some_webpack_config
| |
| |_ node_modules
| |_ package.json
| |_ webpack.client.build.babel.js
| |_ webpack.client.dev.babel.js
|
|_ package.json
|
|_ others Rails project directories…
```

1. `/app/assets/webpack`: All assets generated by webpack should be output inside
   this directory.
2. `/client`: All client-side related files goes under this directory.
3. `/client/.babelrc`: Babel configuration file to enable webpack configuration
   and web-dev server files to be written in es6.
4. `/client/bin/webpack-dev-server.js`: File to start web-dev server for assets
   hot reloading.
5. `/client/app`: All application assets.
6. `/client/config`: Your webpack common configuration files.
7. `/client/package.json`: This `package.json` lists all the dependencies that
   are needed by your webpack configuration.
8. `webpack.***.babel.js`: your webpack configuratiocn files.
9. `package.json`: This `package.json` enable you to run npm command from your
   project root.

You can find an example of all these files in `spec/dummy`.

## Webpack dependencies

The `client/package.json` lists all dependencies that webpack compilation needs.
These modules can be categorized as follow:
- **babel modules**: Babel loader and presets to parse es6 files;
- **webpack loaders**: loaders that enables webpack to require styles, images
and jsx files;
- **webpack plugins**: modules that enables webpack to process files others that
  javascript files.

You can check the file in `spec/dummy/client/package.json` to have the
exhaustive list.

## Build configuration

Configure webpack so it can fetch your assets files as entries and output the
files in the directory you want:

```js
const config = {
  entry: {
    application: [
      // Fetch files to create the output bundle.
      // The path is relative to the present configuration file.
      './app/javascripts/application',
    ]
  },
  output: {
    // Output bundles in `app/assets/webpack` directory.
    path: path.join(__dirname, 'app', 'assets','webpack'),
    filename: '[name]-bundle.js',
  },
}
```

Make sure to declare explicitly the resolve directories for modules and loaders
with an absolute path. This prevents webpack from failing to load required
dependencies.

```js
import path from 'path'
import kitten from 'kitten'

const nodeModulesPath = path.resolve(__dirname, '../../node_modules')

const config = {
  …,
  resolve: {
    // Enable webpack to require kitten files. Enforce `node_modules` directory
    // absolute path.
    root: nodeModulesPath.concat(kitten.jsPaths).concat(kitten.imagesPaths)
  },
  resolveLoader: {
    // Add `node_modules` directory absolute path to make sure webpack can use
    // loaders in every file it requires.
    root: nodeModulesPath
  },
}
```


