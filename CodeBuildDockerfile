FROM ruby:2.3

# Throw errors if Gemfile has been modified since Gemfile.lock
RUN bundle config --global frozen 1
ENV BUNDLE_DEPLOYMENT 1

# Update system
RUN curl -sL https://deb.nodesource.com/setup_8.x | bash -
RUN apt-get install -qqy \
    curl \
    git \
    automake \
    libtool \
    build-essential \
    nodejs \
    perl \
    libwww-perl \
    libnet-http-perl \
    liburi-perl \
    libfile-touch-perl \
    libfile-path-perl \
    libhtml-tokeparser-simple-perl \
    libtemplate-perl \
    liblog-log4perl-perl \
    libhash-merge-perl \
    libyaml-perl

# install app
RUN mkdir -p /usr/src/app
WORKDIR /usr/src/app
ADD . /usr/src/app
# modify client package.json for docker path modification
RUN perl -pi.bak -e "s/(\.\.\/)/\/usr\/src\/app\//" spec/dummy/client/package.json
RUN gem install foreman
